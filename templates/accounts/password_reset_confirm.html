{% extends 'base/base.html' %}
{% load static %}

{% block title %}Set New Password - PesaFlow{% endblock %}

{% block extra_css %}
<style>
    .auth-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 20px;
    }
    .auth-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 420px;
        overflow: hidden;
    }
    .auth-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }
    .auth-header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 700;
    }
    .auth-header p {
        margin: 10px 0 0;
        opacity: 0.9;
        font-size: 14px;
    }
    .auth-body {
        padding: 40px;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
        font-size: 14px;
    }
    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 10px;
        font-size: 15px;
        transition: all 0.3s;
    }
    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        outline: none;
    }
    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        border: none;
        padding: 14px 20px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        width: 100%;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(67, 97, 238, 0.3);
    }
    .requirements {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 25px;
        font-size: 14px;
        color: #666;
        border: 1px solid #e1e5e9;
    }
    .requirements p {
        margin: 0 0 10px;
        font-weight: 600;
    }
    .requirements ul {
        margin: 0;
        padding-left: 20px;
    }
    .login-link {
        text-align: center;
        margin-top: 25px;
        padding-top: 25px;
        border-top: 1px solid #e1e5e9;
        font-size: 14px;
    }
    .login-link a {
        color: var(--primary-color);
        font-weight: 600;
        text-decoration: none;
    }
    .login-link a:hover {
        text-decoration: underline;
    }
    .password-strength {
        margin-top: 5px;
        height: 4px;
        border-radius: 2px;
        background: #e1e5e9;
        overflow: hidden;
    }
    .strength-bar {
        height: 100%;
        width: 0%;
        transition: width 0.3s, background-color 0.3s;
    }
    .strength-weak { background: #ff4757; }
    .strength-fair { background: #ffa502; }
    .strength-good { background: #2ed573; }
    .strength-strong { background: #1e90ff; }
</style>
{% endblock %}

{% block breadcrumb %}{% endblock %}
{% block page_actions %}{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h1>Set New Password</h1>
            <p>Create a new password for your account</p>
        </div>
        
        <div class="auth-body">
            {% include 'base/messages.html' %}
            
            {% if validlink %}
                <div class="requirements">
                    <p>Password Requirements:</p>
                    <ul>
                        <li>At least 8 characters long</li>
                        <li>Include uppercase and lowercase letters</li>
                        <li>Include at least one number</li>
                        <li>Include at least one special character (!@#$%^&*)</li>
                    </ul>
                </div>
                
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label class="form-label" for="new_password">New Password</label>
                        <input type="password" 
                               id="new_password" 
                               name="new_password" 
                               class="form-control" 
                               placeholder="Enter new password"
                               required
                               onkeyup="checkPasswordStrength()">
                        <div class="password-strength">
                            <div class="strength-bar" id="strengthBar"></div>
                        </div>
                        <small id="passwordHelp" style="font-size: 12px; color: #666;"></small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="confirm_password">Confirm Password</label>
                        <input type="password" 
                               id="confirm_password" 
                               name="confirm_password" 
                               class="form-control" 
                               placeholder="Confirm new password"
                               required
                               onkeyup="checkPasswordMatch()">
                        <small id="matchHelp" style="font-size: 12px;"></small>
                    </div>
                    
                    <button type="submit" class="btn-primary" id="submitBtn">Reset Password</button>
                </form>
                
                <div class="login-link">
                    <a href="{% url 'login' %}">← Back to Login</a>
                </div>
                
            {% else %}
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 48px; color: #ff4757; margin-bottom: 20px;">⚠️</div>
                    <h3 style="margin-bottom: 10px; color: #333;">Invalid Reset Link</h3>
                    <p style="color: #666; margin-bottom: 25px;">
                        The password reset link is invalid or has expired.<br>
                        Please request a new password reset link.
                    </p>
                    <a href="{% url 'password_reset' %}" class="btn-primary" style="display: inline-block; width: auto; padding: 12px 30px;">
                        Request New Link
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function checkPasswordStrength() {
        const password = document.getElementById('new_password').value;
        const strengthBar = document.getElementById('strengthBar');
        const passwordHelp = document.getElementById('passwordHelp');
        
        let strength = 0;
        let feedback = '';
        
        // Length check
        if (password.length >= 8) strength += 1;
        
        // Contains lowercase
        if (/[a-z]/.test(password)) strength += 1;
        
        // Contains uppercase
        if (/[A-Z]/.test(password)) strength += 1;
        
        // Contains numbers
        if (/[0-9]/.test(password)) strength += 1;
        
        // Contains special characters
        if (/[^A-Za-z0-9]/.test(password)) strength += 1;
        
        // Update strength bar
        let width = (strength / 5) * 100;
        strengthBar.style.width = width + '%';
        
        // Update color and text based on strength
        if (strength <= 1) {
            strengthBar.className = 'strength-bar strength-weak';
            feedback = 'Weak password';
        } else if (strength === 2) {
            strengthBar.className = 'strength-bar strength-fair';
            feedback = 'Fair password';
        } else if (strength === 3) {
            strengthBar.className = 'strength-bar strength-good';
            feedback = 'Good password';
        } else if (strength >= 4) {
            strengthBar.className = 'strength-bar strength-strong';
            feedback = 'Strong password';
        }
        
        passwordHelp.textContent = feedback;
    }
    
    function checkPasswordMatch() {
        const password = document.getElementById('new_password').value;
        const confirm = document.getElementById('confirm_password').value;
        const matchHelp = document.getElementById('matchHelp');
        
        if (confirm === '') {
            matchHelp.textContent = '';
            matchHelp.style.color = '';
        } else if (password === confirm) {
            matchHelp.textContent = '✓ Passwords match';
            matchHelp.style.color = '#38b000';
        } else {
            matchHelp.textContent = '✗ Passwords do not match';
            matchHelp.style.color = '#ff4757';
        }
    }
</script>
{% endblock %}